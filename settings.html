<div class="fantastical-settings">
  <h3>Fantastical Name Generator</h3>
  <label class="st-flex st-gap-1 st-ai-center">
    <input type="checkbox" id="fn_enable" />
    <span>Use Function Tool</span>
  </label>

  <label class="st-flex st-gap-1 st-ai-center">
    <input type="checkbox" id="fn_slash" />
    <span>Enable /name slash command</span>
  </label>

  <label class="st-flex st-gap-1 st-ai-center">
    <input type="checkbox" id="fn_prefer_cdn" />
    <span>Prefer CDN auto-install (no local npm)</span>
  </label>

  <label class="st-flex st-col">
    <span>CDN URL</span>
    <input type="text" id="fn_cdn_url" placeholder="https://cdn.jsdelivr.net/npm/fantastical@latest/dist/index.js">
  </label>

  <label class="st-flex st-gap-1 st-ai-center">
    <input type="checkbox" id="fn_cache" />
    <span>Cache library in browser storage</span>
  </label>

  <label class="st-flex st-gap-1 st-ai-center">
    <input type="checkbox" id="fn_toasts" />
    <span>Show toasts on tool call</span>
  </label>

  <div class="st-flex st-gap-2 st-mt-1">
    <button id="fn_save" class="menu_button">Save</button>
    <button id="fn_clear_cache" class="menu_button">Clear Cache</button>
    <button id="fn_test" class="menu_button">Test Load</button>
  </div>

  <script>
    (function(){
      const ctx = SillyTavern.getContext();
      const key = 'fantastical_namegen';
      function get() { return (ctx.extensionSettings?.[key]) || {}; }
      function set(values){ ctx.extensionSettings[key] = { ...(get()), ...values }; ctx.saveSettingsDebounced?.(); }

      function refresh(){
        const s = Object.assign({
          enableFunctionTool: true, enableSlashCommand: true, preferCDN: true, cdnUrl: 'https://cdn.jsdelivr.net/npm/fantastical@latest/dist/index.js', cacheModule: true, showToasts: true,
        }, get());
        document.getElementById('fn_enable').checked = !!s.enableFunctionTool;
        document.getElementById('fn_slash').checked = !!s.enableSlashCommand;
        document.getElementById('fn_prefer_cdn').checked = !!s.preferCDN;
        document.getElementById('fn_cdn_url').value = s.cdnUrl || '';
        document.getElementById('fn_cache').checked = !!s.cacheModule;
        document.getElementById('fn_toasts').checked = !!s.showToasts;
      }

      document.getElementById('fn_save').addEventListener('click', () => {
        set({
          enableFunctionTool: document.getElementById('fn_enable').checked,
          enableSlashCommand: document.getElementById('fn_slash').checked,
          preferCDN: document.getElementById('fn_prefer_cdn').checked,
          cdnUrl: document.getElementById('fn_cdn_url').value,
          cacheModule: document.getElementById('fn_cache').checked,
          showToasts: document.getElementById('fn_toasts').checked,
        });
        // trigger re-register
        globalThis.FantasticalNameGen?.reRegister?.();
        ctx.toast?.('Fantastical settings saved');
      });

      document.getElementById('fn_clear_cache').addEventListener('click', async () => {
        try { await localStorage.removeItem('ZhenyaPav/SillyTavern-Namegen:fantastical-src'); } catch (e) {}
        ctx.toast?.('Fantastical cache cleared');
      });

      document.getElementById('fn_test').addEventListener('click', async () => {
        try {
          await globalThis.FantasticalNameGen?.loadFantastical?.();
          ctx.toast?.('Fantastical module loaded OK');
        } catch (e) {
          ctx.toast?.('Failed to load Fantastical â€“ check console & URL');
          console.error(e);
        }
      });

      refresh();
    })();
  </script>
</div>
